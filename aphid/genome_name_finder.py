from Bio import Entrez
from Bio import SeqIO
import pickle
import csv

Entrez.email = 'mct30@miami.edu'

org_names = []

#genbank_accession_numbers = ["NZ_AGCA01000390.1", "NC_015125.1", "AE008922.1", 
#"NZ_CP010799.1", "NZ_CP011058.1", "NC_015727.1", "AE004091.2", 
#"NZ_CP018134.1", "AE016853.1", "NZ_CP010341.1", "NC_003296.1", 
#"BA000040.2", "NZ_CP018762.1", "NZ_CP010537.1", "NC_002947.4", 
#"CP000075.1", "NC_007974.2", "NZ_CP013652.1", "NC_016935.1", 
#"NZ_CP021780.1", "NZ_CP009286.1", "NZ_CP009285.1", "NZ_CP010517.1", 
#"NZ_CP014167.1", "NZ_CP009428.1", "BA000036.3", "AL935263.2", 
#"NZ_CP011388.1", "CP013023.1", "NZ_CP019687.1", "NZ_CP016892.1", 
#"NZ_CP016303.1", "CP000033.3", "NC_006833.1", "NZ_AGCA01000168.1", 
#"NZ_GL379589.1", "NC_002978.6", "NC_018267.1", "CP002295.1", 
#"NZ_CP011856.1", "CP002448.1", "NZ_CP006934.1", "NZ_GL379592.1", 
#"NZ_CP006720.1", "NC_014628.2", "NZ_CP017015.1", "LN890288.1", 
#"NC_021284.1", "NZ_CP012328.1", "NC_021084.1", "NZ_CP006681.1", 
#"AJ235269.1", "NZ_CP012357.1", "NZ_GL379626.1", "NZ_GL379754.1", 
#"NZ_AGCA01000431.1", "NC_022998.1", "NZ_AGCA01000107.1", "CP000234.1", 
#"NZ_CP012622.1", "NZ_GL379727.1", "NZ_AGCA01000491.1", "NZ_CP013920.1", 
#"NC_010683.1", "NC_021280.1", "NZ_AP013028.1", "NZ_GL379664.1", 
#"NZ_AGCA01000125.1", "NZ_GL379751.1", "NZ_AGCA01000251.1", "NZ_AGCA01000307.1", 
#"NZ_AGCA01000316.1", "NC_021846.1", "NZ_AGCA01000169.1", "NC_021833.1", 
#"NZ_GL379665.1", "NZ_AGCA01000245.1", "NZ_GL379688.1", "NZ_GL379591.1", 
#"NZ_AGCA01000258.1", "NZ_GL379686.1", "NZ_AGCA01000392.1", "NZ_AGCA01000016.1", 
#"NZ_GL379590.1", "NZ_CM000957.1", "NZ_AGCA01000541.1", "NZ_AGCA01000425.1", 
#"NZ_AGCA01000406.1", "NZ_AGCA01000430.1", "NZ_AGCA01000317.1", "NZ_AGCA01000465.1", 
#"NZ_AGCA01000426.1", "NZ_AGCA01000361.1", "NZ_AGCA01000295.1", "NZ_GL379718.1", 
#"NZ_GL379656.1", "NZ_GL379618.1", "NZ_AGCA01000536.1", "NZ_AGCA01000459.1", 
#"NZ_AGCA01000435.1", "NZ_AGCA01000328.1", "NZ_AGCA01000137.1", "NZ_AGCA01000068.1", 
#"NZ_AGCA01000037.1", "NZ_AGCA01000012.1", "NZ_GL379757.1", "NZ_GL379749.1", 
#"NZ_GL379746.1", "NZ_GL379700.1", "NZ_GL379669.1", "NZ_GL379662.1", 
#"NZ_GL379610.1", "NZ_GL379605.1", "NZ_AGCA01000561.1", "NZ_AGCA01000543.1", 
#"NZ_AGCA01000514.1", "NZ_AGCA01000476.1", "NZ_AGCA01000467.1", "NZ_AGCA01000464.1", 
#"NZ_AGCA01000410.1", "NZ_AGCA01000400.1", "NZ_AGCA01000371.1", "NZ_AGCA01000296.1", "NZ_AGCA01000265.1", 
#"NZ_AGCA01000248.1", "NZ_AGCA01000212.1", "NZ_AGCA01000211.1", "NZ_AGCA01000198.1", "NZ_AGCA01000133.1", 
#"NZ_AGCA01000109.1", "NZ_AGCA01000082.1", "NZ_AGCA01000023.1", "NZ_AGCA01000019.1", "NZ_AGCA01000018.1", 
#"CP000424.1", "NZ_GL379738.1", "NZ_GL379609.1", "NZ_AGCA01000351.1", "NZ_AGCA01000275.1", 
#"NZ_AGCA01000264.1", "NZ_AGCA01000155.1", "NZ_AGCA01000130.1", "NZ_AGCA01000106.1", "NZ_AGCA01000090.1", 
#"NZ_AGCA01000035.1", "NZ_GL379748.1", "NZ_GL379732.1", "NZ_GL379719.1", "NZ_GL379708.1", 
#"NZ_GL379680.1", "NZ_GL379674.1", "NZ_GL379653.1", "NZ_GL379647.1", "NZ_GL379633.1", 
#"NZ_GL379623.1", "NZ_GL379599.1", "NZ_GL379594.1", "NZ_CP015813.1", "NZ_AGCA01000555.1", 
#"NZ_AGCA01000547.1", "NZ_AGCA01000538.1", "NZ_AGCA01000509.1", "NZ_AGCA01000507.1", "NZ_AGCA01000488.1", 
#"NZ_AGCA01000457.1", "NZ_AGCA01000436.1", "NZ_AGCA01000427.1", "NZ_AGCA01000409.1", "NZ_AGCA01000353.1", 
#"NZ_AGCA01000344.1", "NZ_AGCA01000293.1", "NZ_AGCA01000290.1", "NZ_AGCA01000285.1", "NZ_AGCA01000282.1", 
#"NZ_AGCA01000281.1", "NZ_AGCA01000263.1", "NZ_AGCA01000257.1", "NZ_AGCA01000256.1", "NZ_AGCA01000250.1", 
#"NZ_AGCA01000225.1", "NZ_AGCA01000092.1", "NZ_AGCA01000083.1", "NZ_AGCA01000060.1", "NZ_GL379710.1", 
#"NZ_GL379649.1", "NZ_AGCA01000269.1", "NZ_AGCA01000518.1", "NZ_AGCA01000105.1", "NZ_GL379760.1", 
#"NZ_GL379729.1", "NZ_GL379720.1", "NZ_GL379715.1", "NZ_GL379675.1", "NZ_GL379668.1", 
#"NZ_GL379651.1", "NZ_GL379634.1", "NZ_GL379631.1", "NZ_GL379607.1", "NZ_CP009289.1", 
#"NZ_AGCA01000548.1", "NZ_AGCA01000546.1", "NZ_AGCA01000466.1", "NZ_AGCA01000443.1", "NZ_AGCA01000441.1", 
#"NZ_AGCA01000387.1", "NZ_AGCA01000375.1", "NZ_AGCA01000348.1", "NZ_AGCA01000321.1", "NZ_AGCA01000273.1", 
#"NZ_AGCA01000271.1", "NZ_AGCA01000260.1", "NZ_AGCA01000244.1", "NZ_AGCA01000239.1", "NZ_AGCA01000222.1", 
#"NZ_AGCA01000179.1", "NZ_AGCA01000129.1", "NZ_AGCA01000112.1", "NZ_AGCA01000110.1", "NZ_AGCA01000088.1", 
#"NZ_AGCA01000045.1", "NZ_AGCA01000044.1", "NZ_AGCA01000042.1", "NZ_AGCA01000027.1", "NZ_AGCA01000009.1", 
#"NZ_AGCA01000439.1", "NZ_GL379661.1", "NZ_AGCA01000550.1", "NZ_AGCA01000463.1", "U58771.1", 
#"NZ_GL379704.1", "NZ_GL379679.1", "NZ_GL379663.1", "NZ_GL379639.1", "NZ_GL379627.1", 
#"NZ_AGCA01000539.1", "NZ_AGCA01000521.1", "NZ_AGCA01000513.1", "NZ_AGCA01000462.1", "NZ_AGCA01000374.1", 
#"NZ_AGCA01000373.1", "NZ_AGCA01000308.1", "NZ_AGCA01000306.1", "NZ_AGCA01000298.1", "NZ_AGCA01000143.1", 
#"NZ_AGCA01000135.1", "NZ_AGCA01000103.1", "NZ_AGCA01000084.1", "NZ_AGCA01000056.1", "NZ_AGCA01000033.1", 
#"NZ_AGCA01000017.1", "NZ_GL379736.1", "NZ_GL379723.1", "NZ_AGCA01000040.1", "NZ_GL379619.1", 
#"NZ_GL379615.1", "NZ_GL379596.1", "NZ_GL379595.1", "NZ_CP012425.1", "NZ_AGCA01000519.1", 
#"NZ_AGCA01000505.1", "NZ_AGCA01000486.1", "NZ_AGCA01000468.1", "NZ_AGCA01000369.1", "NZ_AGCA01000345.1", 
#"NZ_AGCA01000341.1", "NZ_AGCA01000304.1", "NZ_AGCA01000303.1", "NZ_AGCA01000283.1", "NZ_AGCA01000032.1", 
#]

genebank_ids = []

with open('C:\\Users\\Thompson\\Downloads\\viruses2_sq_lines.tsv', 'r') as f:
    csvreader = csv.reader(f)
    for row in csvreader:
        genebank_ids.append(row[0])
#%%
efetch_handle = Entrez.efetch(db = 'nuccore', id = genebank_ids, 
                              rettype = 'gb', retmode = 'text')
efetch_records = SeqIO.parse(efetch_handle, 'gb')
# Search all accession numbers at once to avoid API search limits at NCBI
#for (record, genbank_accession_number) in zip(efetch_records, genbank_accession_numbers):
for record in efetch_records:
    nuccore_id = record.id
    organism_name = record.annotations['organism']
    description = record.description
#    record_GBA = str(record.annotations['accessions'][0])
#    if record_GBA in str(genbank_accession_number):
#        genomes_dict[organism_name] = genomes_dict.pop(genbank_accession_number)
#    else:
#        print('Records not aligned')
#    # Pulls the organism name from the annotations of the SeqRecord
#    # object to identify the genome later on in output files
#    genomes_dict[organism_name].append(record.description)
#    # Added description to end of readnums list because it contains strain 
#    # and genome info
#    print(organism_name)
    entry = [organism_name, nuccore_id, description]
    org_names.append(entry)
    print(entry)

with open('viruses2_org_names.pkl', 'wb') as list_file:
    pickle.dump(org_names, list_file, protocol = pickle.HIGHEST_PROTOCOL)
